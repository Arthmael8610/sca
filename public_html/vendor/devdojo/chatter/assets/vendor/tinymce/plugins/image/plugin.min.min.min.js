tinymce.PluginManager.add("image",function(d){function e(g,h){function i(k,l){j.parentNode&&j.parentNode.removeChild(j),h({width:k,height:l})}var j=document.createElement("img");j.onload=function(){i(Math.max(j.width,j.clientWidth),Math.max(j.height,j.clientHeight))},j.onerror=function(){i()};var f=j.style;f.visibility="hidden",f.position="fixed",f.bottom=f.left=0,f.width=f.height="auto",document.body.appendChild(j),j.src=g}function a(h,i,f){function g(j,k){return k=k||[],tinymce.each(j,function(m){var l={text:m.text||m.title};m.menu?l.menu=g(m.menu):(l.value=m.value,i(l)),k.push(l)}),k}return g(h,f||[])}function b(f){return function(){var g=d.settings.image_list;"string"==typeof g?tinymce.util.XHR.send({url:g,success:function(h){f(tinymce.util.JSON.parse(h))}}):"function"==typeof g?g(f):f(g)}}function c(f){function g(){var y,z,w,x;y=r.find("#width")[0],z=r.find("#height")[0],y&&z&&(w=y.value(),x=z.value(),r.find("#constrain")[0].checked()&&u&&h&&w&&x&&(u!=w?(x=Math.round(w/u*x),isNaN(x)||z.value(x)):(w=Math.round(x/h*w),isNaN(w)||y.value(w))),u=w,h=x)}function i(){function y(A){function z(){A.onload=A.onerror=null,d.selection&&(d.selection.select(A),d.nodeChanged())}A.onload=function(){n.width||n.height||!M||v.setAttribs(A,{width:A.clientWidth,height:A.clientHeight}),z()},A.onerror=z}var w,x;p(),g(),n=tinymce.extend(n,r.toJSON()),n.alt||(n.alt=""),n.title||(n.title=""),""===n.width&&(n.width=null),""===n.height&&(n.height=null),n.style||(n.style=null),n={src:n.src,alt:n.alt,title:n.title,width:n.width,height:n.height,style:n.style,caption:n.caption,"class":n["class"]},d.undoManager.transact(function(){function z(B){return d.schema.getTextBlockElements()[B.nodeName]}if(!n.src){return void (s&&(v.remove(s),d.focus(),d.nodeChanged()))}if(""===n.title&&(n.title=null),s?v.setAttribs(s,n):(n.id="__mcenew",d.focus(),d.selection.setContent(v.createHTML("img",n)),s=v.get("__mcenew"),v.setAttrib(s,"id",null)),d.editorUpload.uploadImagesAuto(),n.caption===!1&&v.is(s.parentNode,"figure.image")&&(w=s.parentNode,v.insertAfter(s,w),v.remove(w)),n.caption!==!0){y(s)}else{if(!v.is(s.parentNode,"figure.image")){x=s,s=s.cloneNode(!0),w=v.create("figure",{"class":"image"}),w.appendChild(s),w.appendChild(v.create("figcaption",{contentEditable:!0},"Caption")),w.contentEditable=!1;var A=v.getParent(x,z);A?v.split(A,x,w):v.replace(w,x),d.selection.select(w)}}})}function k(w){return w&&(w=w.replace(/px$/,"")),w}function m(z){var A,w,x,y=z.meta||{};j&&j.value(d.convertURL(this.value(),"src")),tinymce.each(y,function(B,C){r.find("#"+C).value(B)}),y.width||y.height||(A=d.convertURL(this.value(),"src"),w=d.settings.image_prepend_url,x=new RegExp("^(?:[a-z]+:)?//","i"),w&&!x.test(A)&&A.substring(0,w.length)!==w&&(A=w+A),this.value(A),e(d.documentBaseURI.toAbsolute(this.value()),function(B){B.width&&B.height&&M&&(u=B.width,h=B.height,r.find("#width").value(u),r.find("#height").value(h))}))}function o(w){if(w.margin){var x=w.margin.split(" ");switch(x.length){case 1:w["margin-top"]=w["margin-top"]||x[0],w["margin-right"]=w["margin-right"]||x[0],w["margin-bottom"]=w["margin-bottom"]||x[0],w["margin-left"]=w["margin-left"]||x[0];break;case 2:w["margin-top"]=w["margin-top"]||x[0],w["margin-right"]=w["margin-right"]||x[1],w["margin-bottom"]=w["margin-bottom"]||x[0],w["margin-left"]=w["margin-left"]||x[1];break;case 3:w["margin-top"]=w["margin-top"]||x[0],w["margin-right"]=w["margin-right"]||x[1],w["margin-bottom"]=w["margin-bottom"]||x[2],w["margin-left"]=w["margin-left"]||x[1];break;case 4:w["margin-top"]=w["margin-top"]||x[0],w["margin-right"]=w["margin-right"]||x[1],w["margin-bottom"]=w["margin-bottom"]||x[2],w["margin-left"]=w["margin-left"]||x[3]}delete w.margin}return w}function p(){function y(z){return z.length>0&&/^[0-9]+$/.test(z)&&(z+="px"),z}if(d.settings.image_advtab){var w=r.toJSON(),x=v.parseStyle(w.style);x=o(x),w.vspace&&(x["margin-top"]=x["margin-bottom"]=y(w.vspace)),w.hspace&&(x["margin-left"]=x["margin-right"]=y(w.hspace)),w.border&&(x["border-width"]=y(w.border)),r.find("#style").value(v.serializeStyle(v.parseStyle(v.serializeStyle(x))))}}function q(){if(d.settings.image_advtab){var x=r.toJSON(),w=v.parseStyle(x.style);r.find("#vspace").value(""),r.find("#hspace").value(""),w=o(w),(w["margin-top"]&&w["margin-bottom"]||w["margin-right"]&&w["margin-left"])&&(w["margin-top"]===w["margin-bottom"]?r.find("#vspace").value(k(w["margin-top"])):r.find("#vspace").value(""),w["margin-right"]===w["margin-left"]?r.find("#hspace").value(k(w["margin-right"])):r.find("#hspace").value("")),w["border-width"]&&r.find("#border").value(k(w["border-width"])),r.find("#style").value(v.serializeStyle(v.parseStyle(v.serializeStyle(w))))}}var r,s,t,u,h,j,l,n={},v=d.dom,M=d.settings.image_dimensions!==!1;s=d.selection.getNode(),t=v.getParent(s,"figure.image"),t&&(s=v.select("img",t)[0]),s&&("IMG"!=s.nodeName||s.getAttribute("data-mce-object")||s.getAttribute("data-mce-placeholder"))&&(s=null),s&&(u=v.getAttrib(s,"width"),h=v.getAttrib(s,"height"),n={src:v.getAttrib(s,"src"),alt:v.getAttrib(s,"alt"),title:v.getAttrib(s,"title"),"class":v.getAttrib(s,"class"),width:u,height:h,caption:!!t}),f&&(j={type:"listbox",label:"Image list",values:a(f,function(w){w.value=d.convertURL(w.value||w.url,"src")},[{text:"None",value:""}]),value:n.src&&d.convertURL(n.src,"src"),onselect:function(w){var x=r.find("#alt");(!x.value()||w.lastControl&&x.value()==w.lastControl.text())&&x.value(w.control.text()),r.find("#src").value(w.control.value()).fire("change")},onPostRender:function(){j=this}}),d.settings.image_class_list&&(l={name:"class",type:"listbox",label:"Class",values:a(d.settings.image_class_list,function(w){w.value&&(w.textStyle=function(){return d.formatter.getCssText({inline:"img",classes:[w.value]})})})});var N=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:m},j];d.settings.image_description!==!1&&N.push({name:"alt",type:"textbox",label:"Image description"}),d.settings.image_title&&N.push({name:"title",type:"textbox",label:"Image Title"}),M&&N.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:g,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:g,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),N.push(l),d.settings.image_caption&&tinymce.Env.ceFalse&&N.push({name:"caption",type:"checkbox",label:"Caption"}),d.settings.image_advtab?(s&&(s.style.marginLeft&&s.style.marginRight&&s.style.marginLeft===s.style.marginRight&&(n.hspace=k(s.style.marginLeft)),s.style.marginTop&&s.style.marginBottom&&s.style.marginTop===s.style.marginBottom&&(n.vspace=k(s.style.marginTop)),s.style.borderWidth&&(n.border=k(s.style.borderWidth)),n.style=d.dom.serializeStyle(d.dom.parseStyle(d.dom.getAttrib(s,"style")))),r=d.windowManager.open({title:"Insert/edit image",data:n,bodyType:"tabpanel",body:[{title:"General",type:"form",items:N},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:q},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:p},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:i})):r=d.windowManager.open({title:"Insert/edit image",data:n,body:N,onSubmit:i})}d.on("preInit",function(){function f(h){var i=h.attr("class");return i&&/\bimage\b/.test(i)}function g(h){return function(p){function i(k){k.attr("contenteditable",h?"true":null)}for(var j,o=p.length;o--;){j=p[o],f(j)&&(j.attr("contenteditable",h?"false":null),tinymce.each(j.getAll("figcaption"),i))}}}d.parser.addNodeFilter("figure",g(!0)),d.serializer.addNodeFilter("figure",g(!1))}),d.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:b(c),stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"}),d.addMenuItem("image",{icon:"image",text:"Insert/edit image",onclick:b(c),context:"insert",prependToContext:!0}),d.addCommand("mceImage",b(c))});