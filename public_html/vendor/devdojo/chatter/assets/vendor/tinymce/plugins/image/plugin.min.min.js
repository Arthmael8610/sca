tinymce.PluginManager.add("image",function(g){function f(l,k){function o(b,d){n.parentNode&&n.parentNode.removeChild(n),k({width:b,height:d})}var n=document.createElement("img");n.onload=function(){o(Math.max(n.width,n.clientWidth),Math.max(n.height,n.clientHeight))},n.onerror=function(){o()};var m=n.style;m.visibility="hidden",m.position="fixed",m.bottom=m.left=0,m.width=m.height="auto",document.body.appendChild(n),n.src=l}function j(k,e,m){function l(b,d){return d=d||[],tinymce.each(b,function(c){var n={text:c.text||c.title};c.menu?n.menu=l(c.menu):(n.value=c.value,e(n)),d.push(n)}),d}return l(k,m||[])}function i(a){return function(){var b=g.settings.image_list;"string"==typeof b?tinymce.util.XHR.send({url:b,success:function(c){a(tinymce.util.JSON.parse(c))}}):"function"==typeof b?b(a):a(b)}}function h(L){function K(){var k,e,m,l;k=D.find("#width")[0],e=D.find("#height")[0],k&&e&&(m=k.value(),l=e.value(),D.find("#constrain")[0].checked()&&A&&z&&m&&l&&(A!=m?(l=Math.round(m/A*l),isNaN(l)||e.value(l)):(m=Math.round(l/z*m),isNaN(m)||k.value(m))),A=m,z=l)}function J(){function e(d){function m(){d.onload=d.onerror=null,g.selection&&(g.selection.select(d),g.nodeChanged())}d.onload=function(){w.width||w.height||!b||c.setAttribs(d,{width:d.clientWidth,height:d.clientHeight}),m()},d.onerror=m}var l,k;F(),K(),w=tinymce.extend(w,D.toJSON()),w.alt||(w.alt=""),w.title||(w.title=""),""===w.width&&(w.width=null),""===w.height&&(w.height=null),w.style||(w.style=null),w={src:w.src,alt:w.alt,title:w.title,width:w.width,height:w.height,style:w.style,caption:w.caption,"class":w["class"]},g.undoManager.transact(function(){function m(n){return g.schema.getTextBlockElements()[n.nodeName]}if(!w.src){return void (C&&(c.remove(C),g.focus(),g.nodeChanged()))}if(""===w.title&&(w.title=null),C?c.setAttribs(C,w):(w.id="__mcenew",g.focus(),g.selection.setContent(c.createHTML("img",w)),C=c.get("__mcenew"),c.setAttrib(C,"id",null)),g.editorUpload.uploadImagesAuto(),w.caption===!1&&c.is(C.parentNode,"figure.image")&&(l=C.parentNode,c.insertAfter(C,l),c.remove(l)),w.caption!==!0){e(C)}else{if(!c.is(C.parentNode,"figure.image")){k=C,C=C.cloneNode(!0),l=c.create("figure",{"class":"image"}),l.appendChild(C),l.appendChild(c.create("figcaption",{contentEditable:!0},"Caption")),l.contentEditable=!1;var d=c.getParent(k,m);d?c.split(d,k,l):c.replace(l,k),g.selection.select(l)}}})}function I(d){return d&&(d=d.replace(/px$/,"")),d}function H(o){var n,m,l,k=o.meta||{};y&&y.value(g.convertURL(this.value(),"src")),tinymce.each(k,function(e,d){D.find("#"+d).value(e)}),k.width||k.height||(n=g.convertURL(this.value(),"src"),m=g.settings.image_prepend_url,l=new RegExp("^(?:[a-z]+:)?//","i"),m&&!l.test(n)&&n.substring(0,m.length)!==m&&(n=m+n),this.value(n),f(g.documentBaseURI.toAbsolute(this.value()),function(d){d.width&&d.height&&b&&(A=d.width,z=d.height,D.find("#width").value(A),D.find("#height").value(z))}))}function G(e){if(e.margin){var d=e.margin.split(" ");switch(d.length){case 1:e["margin-top"]=e["margin-top"]||d[0],e["margin-right"]=e["margin-right"]||d[0],e["margin-bottom"]=e["margin-bottom"]||d[0],e["margin-left"]=e["margin-left"]||d[0];break;case 2:e["margin-top"]=e["margin-top"]||d[0],e["margin-right"]=e["margin-right"]||d[1],e["margin-bottom"]=e["margin-bottom"]||d[0],e["margin-left"]=e["margin-left"]||d[1];break;case 3:e["margin-top"]=e["margin-top"]||d[0],e["margin-right"]=e["margin-right"]||d[1],e["margin-bottom"]=e["margin-bottom"]||d[2],e["margin-left"]=e["margin-left"]||d[1];break;case 4:e["margin-top"]=e["margin-top"]||d[0],e["margin-right"]=e["margin-right"]||d[1],e["margin-bottom"]=e["margin-bottom"]||d[2],e["margin-left"]=e["margin-left"]||d[3]}delete e.margin}return e}function F(){function e(d){return d.length>0&&/^[0-9]+$/.test(d)&&(d+="px"),d}if(g.settings.image_advtab){var l=D.toJSON(),k=c.parseStyle(l.style);k=G(k),l.vspace&&(k["margin-top"]=k["margin-bottom"]=e(l.vspace)),l.hspace&&(k["margin-left"]=k["margin-right"]=e(l.hspace)),l.border&&(k["border-width"]=e(l.border)),D.find("#style").value(c.serializeStyle(c.parseStyle(c.serializeStyle(k))))}}function E(){if(g.settings.image_advtab){var d=D.toJSON(),e=c.parseStyle(d.style);D.find("#vspace").value(""),D.find("#hspace").value(""),e=G(e),(e["margin-top"]&&e["margin-bottom"]||e["margin-right"]&&e["margin-left"])&&(e["margin-top"]===e["margin-bottom"]?D.find("#vspace").value(I(e["margin-top"])):D.find("#vspace").value(""),e["margin-right"]===e["margin-left"]?D.find("#hspace").value(I(e["margin-right"])):D.find("#hspace").value("")),e["border-width"]&&D.find("#border").value(I(e["border-width"])),D.find("#style").value(c.serializeStyle(c.parseStyle(c.serializeStyle(e))))}}var D,C,B,A,z,y,x,w={},c=g.dom,b=g.settings.image_dimensions!==!1;C=g.selection.getNode(),B=c.getParent(C,"figure.image"),B&&(C=c.select("img",B)[0]),C&&("IMG"!=C.nodeName||C.getAttribute("data-mce-object")||C.getAttribute("data-mce-placeholder"))&&(C=null),C&&(A=c.getAttrib(C,"width"),z=c.getAttrib(C,"height"),w={src:c.getAttrib(C,"src"),alt:c.getAttrib(C,"alt"),title:c.getAttrib(C,"title"),"class":c.getAttrib(C,"class"),width:A,height:z,caption:!!B}),L&&(y={type:"listbox",label:"Image list",values:j(L,function(d){d.value=g.convertURL(d.value||d.url,"src")},[{text:"None",value:""}]),value:w.src&&g.convertURL(w.src,"src"),onselect:function(e){var d=D.find("#alt");(!d.value()||e.lastControl&&d.value()==e.lastControl.text())&&d.value(e.control.text()),D.find("#src").value(e.control.value()).fire("change")},onPostRender:function(){y=this}}),g.settings.image_class_list&&(x={name:"class",type:"listbox",label:"Class",values:j(g.settings.image_class_list,function(d){d.value&&(d.textStyle=function(){return g.formatter.getCssText({inline:"img",classes:[d.value]})})})});var a=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:H},y];g.settings.image_description!==!1&&a.push({name:"alt",type:"textbox",label:"Image description"}),g.settings.image_title&&a.push({name:"title",type:"textbox",label:"Image Title"}),b&&a.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:K,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:K,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),a.push(x),g.settings.image_caption&&tinymce.Env.ceFalse&&a.push({name:"caption",type:"checkbox",label:"Caption"}),g.settings.image_advtab?(C&&(C.style.marginLeft&&C.style.marginRight&&C.style.marginLeft===C.style.marginRight&&(w.hspace=I(C.style.marginLeft)),C.style.marginTop&&C.style.marginBottom&&C.style.marginTop===C.style.marginBottom&&(w.vspace=I(C.style.marginTop)),C.style.borderWidth&&(w.border=I(C.style.borderWidth)),w.style=g.dom.serializeStyle(g.dom.parseStyle(g.dom.getAttrib(C,"style")))),D=g.windowManager.open({title:"Insert/edit image",data:w,bodyType:"tabpanel",body:[{title:"General",type:"form",items:a},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:E},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:F},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:J})):D=g.windowManager.open({title:"Insert/edit image",data:w,body:a,onSubmit:J})}g.on("preInit",function(){function a(e){var c=e.attr("class");return c&&/\bimage\b/.test(c)}function d(b){return function(n){function m(c){c.attr("contenteditable",b?"true":null)}for(var l,k=n.length;k--;){l=n[k],a(l)&&(l.attr("contenteditable",b?"false":null),tinymce.each(l.getAll("figcaption"),m))}}}g.parser.addNodeFilter("figure",d(!0)),g.serializer.addNodeFilter("figure",d(!1))}),g.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:i(h),stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"}),g.addMenuItem("image",{icon:"image",text:"Insert/edit image",onclick:i(h),context:"insert",prependToContext:!0}),g.addCommand("mceImage",i(h))});