tinymce.PluginManager.add("media",function(n,p){function b(q){return q=q.toLowerCase(),-1!=q.indexOf(".mp3")?"audio/mpeg":-1!=q.indexOf(".wav")?"audio/wav":-1!=q.indexOf(".mp4")?"video/mp4":-1!=q.indexOf(".webm")?"video/webm":-1!=q.indexOf(".ogg")?"video/ogg":-1!=q.indexOf(".swf")?"application/x-shockwave-flash":""}function d(q){var r=n.settings.media_scripts;if(r){for(var s=0;s<r.length;s++){if(-1!==q.indexOf(r[s].filter)){return r[s]}}}}function e(){function u(B){var C,y,z,A;C=w.find("#width")[0],y=w.find("#height")[0],z=C.value(),A=y.value(),w.find("#constrain")[0].checked()&&x&&r&&z&&A&&(B.control==C?(A=Math.round(z/x*A),isNaN(A)||y.value(A)):(z=Math.round(A/r*z),isNaN(z)||C.value(z))),x=z,r=A}function v(){s=h(this.value()),this.parent().parent().fromJSON(s)}var w,x,r,s,t=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onchange:function(y){tinymce.each(y.meta,function(z,A){w.find("#"+A).value(z)})}}];n.settings.media_alt_source!==!1&&t.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"}),n.settings.media_poster!==!1&&t.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"}),n.settings.media_dimensions!==!1&&t.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:u,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:u,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),s=i(n.selection.getNode()),x=s.width,r=s.height;var q={id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:f(),multiline:!0,label:"Source"};q[c]=v,w=n.windowManager.open({title:"Insert/edit video",data:s,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){s=h(this.next().find("#embed").value()),this.fromJSON(s)},items:t},{title:"Embed",type:"container",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(g(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},q]}],onSubmit:function(){var B,y,z,A;for(B=n.dom.select("img[data-mce-object]"),n.insertContent(g(this.toJSON())),y=n.dom.select("img[data-mce-object]"),z=0;z<B.length;z++){for(A=y.length-1;A>=0;A--){B[z]==y[A]&&y.splice(A,1)}}n.selection.select(y[0]),n.nodeChanged()}})}function f(){var q=n.selection.getNode();return q.getAttribute("data-mce-object")?n.selection.getContent():void 0}function g(s){var t="";if(!s.source1&&(tinymce.extend(s,h(s.embed)),!s.source1)){return""}if(s.source2||(s.source2=""),s.poster||(s.poster=""),s.source1=n.convertURL(s.source1,"source"),s.source2=n.convertURL(s.source2,"source"),s.source1mime=b(s.source1),s.source2mime=b(s.source2),s.poster=n.convertURL(s.poster,"poster"),s.flashPlayerUrl=n.convertURL(p+"/moxieplayer.swf","movie"),tinymce.each(a,function(w){var x,u,v;if(x=w.regex.exec(s.source1)){for(v=w.url,u=0;x[u];u++){v=v.replace("$"+u,function(){return x[u]})}s.source1=v,s.type=w.type,s.allowFullscreen=w.allowFullscreen,s.width=s.width||w.w,s.height=s.height||w.h}}),s.embed){t=k(s.embed,s,!0)}else{var q=d(s.source1);if(q&&(s.type="script",s.width=q.width,s.height=q.height),s.width=s.width||300,s.height=s.height||150,tinymce.each(s,function(v,u){s[u]=n.dom.encode(v)}),"iframe"==s.type){var r=s.allowFullscreen?' allowFullscreen="1"':"";t+='<iframe src="'+s.source1+'" width="'+s.width+'" height="'+s.height+'"'+r+"></iframe>"}else{"application/x-shockwave-flash"==s.source1mime?(t+='<object data="'+s.source1+'" width="'+s.width+'" height="'+s.height+'" type="application/x-shockwave-flash">',s.poster&&(t+='<img src="'+s.poster+'" width="'+s.width+'" height="'+s.height+'" />'),t+="</object>"):-1!=s.source1mime.indexOf("audio")?n.settings.audio_template_callback?t=n.settings.audio_template_callback(s):t+='<audio controls="controls" src="'+s.source1+'">'+(s.source2?'\n<source src="'+s.source2+'"'+(s.source2mime?' type="'+s.source2mime+'"':"")+" />\n":"")+"</audio>":"script"==s.type?t+='<script src="'+s.source1+'"><\/script>':t=n.settings.video_template_callback?n.settings.video_template_callback(s):'<video width="'+s.width+'" height="'+s.height+'"'+(s.poster?' poster="'+s.poster+'"':"")+' controls="controls">\n<source src="'+s.source1+'"'+(s.source1mime?' type="'+s.source1mime+'"':"")+" />\n"+(s.source2?'<source src="'+s.source2+'"'+(s.source2mime?' type="'+s.source2mime+'"':"")+" />\n":"")+"</video>"}}return t}function h(q){var r={};return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(s,t){if(r.source1||"param"!=s||(r.source1=t.map.movie),"iframe"!=s&&"object"!=s&&"embed"!=s&&"video"!=s&&"audio"!=s||(r.type||(r.type=s),r=tinymce.extend(t.map,r)),"script"==s){var u=d(t.map.src);if(!u){return}r={type:"script",source1:t.map.src,width:u.width,height:u.height}}"source"==s&&(r.source1?r.source2||(r.source2=t.map.src):r.source1=t.map.src),"img"!=s||r.poster||(r.poster=t.map.src)}}).parse(q),r.source1=r.source1||r.src||r.data,r.source2=r.source2||"",r.poster=r.poster||"",r}function i(q){return q.getAttribute("data-mce-object")?h(n.serializer.serialize(q,{selection:!0})):{}}function j(q){if(n.settings.media_filter_html===!1){return q}var r,s=new tinymce.html.Writer;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!1,special:"script,noscript",comment:function(t){s.comment(t)},cdata:function(t){s.cdata(t)},text:function(t,u){s.text(t,u)},start:function(w,t,u){if(r=!0,"script"!=w&&"noscript"!=w){for(var v=0;v<t.length;v++){if(0===t[v].name.indexOf("on")){return}"style"==t[v].name&&(t[v].value=n.dom.serializeStyle(n.dom.parseStyle(t[v].value),w))}s.start(w,t,u),r=!1}},end:function(t){r||s.end(t)}},new tinymce.html.Schema({})).parse(q),s.getContent()}function k(u,v,w){function q(C,A){var x,y,z,B;for(x in A){if(z=""+A[x],C.map[x]){for(y=C.length;y--;){B=C[y],B.name==x&&(z?(C.map[x]=z,B.value=z):(delete C.map[x],C.splice(y,1)))}}else{z&&(C.push({name:x,value:z}),C.map[x]=z)}}}var r,s=new tinymce.html.Writer,t=0;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(x){s.comment(x)},cdata:function(x){s.cdata(x)},text:function(x,y){s.text(x,y)},start:function(x,y,z){switch(x){case"video":case"object":case"embed":case"img":case"iframe":q(y,{width:v.width,height:v.height})}if(w){switch(x){case"video":q(y,{poster:v.poster,src:""}),v.source2&&q(y,{src:""});break;case"iframe":q(y,{src:v.source1});break;case"source":if(t++,2>=t&&(q(y,{src:v["source"+t],type:v["source"+t+"mime"]}),!v["source"+t])){return}break;case"img":if(!v.poster){return}r=!0}}s.start(x,y,z)},end:function(x){if("video"==x&&w){for(var y=1;2>=y;y++){if(v["source"+y]){var z=[];z.map={},y>t&&(q(z,{src:v["source"+y],type:v["source"+y+"mime"]}),s.start("source",z,!0))}}}if(v.poster&&"object"==x&&w&&!r){var A=[];A.map={},q(A,{src:v.poster,width:v.width,height:v.height}),s.start("img",A,!0)}s.end(x)}},new tinymce.html.Schema({})).parse(u),s.getContent()}function l(s,w){var q,r,t,u,v;for(t=s.attributes,u=t.length;u--;){q=t[u].name,r=t[u].value,"width"!==q&&"height"!==q&&"style"!==q&&("data"!=q&&"src"!=q||(r=n.convertURL(r,q)),w.attr("data-mce-p-"+q,r))}v=s.firstChild&&s.firstChild.value,v&&(w.attr("data-mce-html",escape(v)),w.firstChild=null)}function m(r){var s,q=r.name;return s=new tinymce.html.Node("img",1),s.shortEnded=!0,l(r,s),s.attr({width:r.attr("width")||"300",height:r.attr("height")||("audio"==q?"30":"150"),style:r.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":q,"class":"mce-object mce-object-"+q}),s}function o(t){var u,q,r,s=t.name;return u=new tinymce.html.Node("span",1),u.attr({contentEditable:"false",style:t.attr("style"),"data-mce-object":s,"class":"mce-preview-object mce-object-"+s}),l(t,u),q=new tinymce.html.Node(s,1),q.attr({src:t.attr("src"),allowfullscreen:t.attr("allowfullscreen"),width:t.attr("width")||"300",height:t.attr("height")||("audio"==s?"30":"150"),frameborder:"0"}),r=new tinymce.html.Node("span",1),r.attr("class","mce-shim"),u.append(q),u.append(r),u}var a=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$2",allowFullscreen:!0},{regex:/youtube.com\/embed\/([a-z0-9\-_]+(?:\?.+)?)/i,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc",allowfullscreen:!0},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&amp;byline=0",allowfullscreen:!0},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"',allowFullscreen:!1},{regex:/dailymotion\.com\/video\/([^_]+)/,type:"iframe",w:480,h:270,url:"//www.dailymotion.com/embed/video/$1",allowFullscreen:!0}],c=tinymce.Env.ie&&tinymce.Env.ie<=8?"onChange":"onInput";n.on("ResolveName",function(q){var r;1==q.target.nodeType&&(r=q.target.getAttribute("data-mce-object"))&&(q.name=r)}),n.on("preInit",function(){var q=n.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(s){q[s]=new RegExp("</"+s+"[^>]*>","gi")});var r=n.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(s){r[s]={}}),n.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(w){for(var s,t,u,v=w.length;v--;){s=w[v],s.parent&&(s.parent.attr("data-mce-object")||("script"!=s.name||(u=d(s.attr("src"))))&&(u&&(u.width&&s.attr("width",u.width.toString()),u.height&&s.attr("height",u.height.toString())),t="iframe"==s.name&&n.settings.media_live_embeds!==!1&&tinymce.Env.ceFalse?o(s):m(s),s.replace(t)))}}),n.serializer.addAttributeFilter("data-mce-object",function(w,x){for(var y,z,A,B,C,D,s,t,u=w.length;u--;){if(y=w[u],y.parent){for(s=y.attr(x),z=new tinymce.html.Node(s,1),"audio"!=s&&"script"!=s&&(t=y.attr("class"),t&&-1!==t.indexOf("mce-preview-object")?z.attr({width:y.firstChild.attr("width"),height:y.firstChild.attr("height")}):z.attr({width:y.attr("width"),height:y.attr("height")})),z.attr({style:y.attr("style")}),B=y.attributes,A=B.length;A--;){var v=B[A].name;0===v.indexOf("data-mce-p-")&&z.attr(v.substr(11),B[A].value)}"script"==s&&z.attr("type","text/javascript"),C=y.attr("data-mce-html"),C&&(D=new tinymce.html.Node("#text",3),D.raw=!0,D.value=j(unescape(C)),z.append(D)),y.replace(z)}}})}),n.on("click keyup",function(){var q=n.selection.getNode();q&&n.dom.hasClass(q,"mce-preview-object")&&n.dom.getAttrib(q,"data-mce-selected")&&q.setAttribute("data-mce-selected","2")}),n.on("ObjectSelected",function(q){var r=q.target.getAttribute("data-mce-object");"audio"!=r&&"script"!=r||q.preventDefault()}),n.on("objectResized",function(r){var s,q=r.target;q.getAttribute("data-mce-object")&&(s=q.getAttribute("data-mce-html"),s&&(s=unescape(s),q.setAttribute("data-mce-html",escape(k(s,{width:r.width,height:r.height})))))}),n.addButton("media",{tooltip:"Insert/edit video",onclick:e,stateSelector:["img[data-mce-object]","span[data-mce-object]"]}),n.addMenuItem("media",{icon:"media",text:"Insert/edit video",onclick:e,context:"insert",prependToContext:!0}),n.on("setContent",function(){n.$("span.mce-preview-object").each(function(q,r){var s=n.$(r);0===s.find("span.mce-shim",r).length&&s.append('<span class="mce-shim"></span>')})}),n.addCommand("mceMedia",e),this.showDialog=e});