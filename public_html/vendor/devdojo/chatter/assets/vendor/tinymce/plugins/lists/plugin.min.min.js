tinymce.PluginManager.add("lists",function(r){function q(a){return r.$.contains(r.getBody(),a)}function p(b){return b&&"BR"==b.nodeName}function o(b){return b&&/^(OL|UL|DL)$/.test(b.nodeName)&&q(b)}function n(b){return b.parentNode.firstChild==b}function m(b){return b.parentNode.lastChild==b}function l(a){return a&&!!r.schema.getTextBlockElements()[a.nodeName]}function k(a){return a===r.getBody()}var j=this;r.on("init",function(){function P(t,s){var u=I.isEmpty(t);return s&&I.select("span[data-mce-type=bookmark]").length>0?!1:u}function O(t){function s(v){var y,x,w;x=t[v?"startContainer":"endContainer"],w=t[v?"startOffset":"endOffset"],1==x.nodeType&&(y=I.create("span",{"data-mce-type":"bookmark"}),x.hasChildNodes()?(w=Math.min(w,x.childNodes.length-1),v?x.insertBefore(y,x.childNodes[w]):I.insertAfter(y,x.childNodes[w])):x.appendChild(y),x=y,w=0),u[v?"startContainer":"endContainer"]=x,u[v?"startOffset":"endOffset"]=w}var u={};return s(!0),t.collapsed||s(),u}function N(t){function s(v){function z(B){for(var A=B.parentNode.firstChild,C=0;A;){if(A==B){return C}1==A.nodeType&&"bookmark"==A.getAttribute("data-mce-type")||C++,A=A.nextSibling}return -1}var y,x,w;y=w=t[v?"startContainer":"endContainer"],x=t[v?"startOffset":"endOffset"],y&&(1==y.nodeType&&(x=z(y),y=y.parentNode,I.remove(w)),t[v?"startContainer":"endContainer"]=y,t[v?"startOffset":"endOffset"]=x)}s(!0),s();var u=I.createRng();u.setStart(t.startContainer,t.startOffset),t.endContainer&&u.setEnd(t.endContainer,t.endOffset),G.setRng(u)}function M(s,z){var y,x,w,v=I.createFragment(),u=r.schema.getBlockElements();if(r.settings.forced_root_block&&(z=z||r.settings.forced_root_block),z&&(x=I.create(z),x.tagName===r.settings.forced_root_block&&I.setAttribs(x,r.settings.forced_root_block_attrs),v.appendChild(x)),s){for(;y=s.firstChild;){var t=y.nodeName;w||"SPAN"==t&&"bookmark"==y.getAttribute("data-mce-type")||(w=!0),u[t]?(v.appendChild(y),x=null):z?(x||(x=I.create(z),v.appendChild(x)),x.appendChild(y)):v.appendChild(y)}}return r.settings.forced_root_block?w||tinymce.Env.ie&&!(tinymce.Env.ie>10)||x.appendChild(I.create("br",{"data-mce-bogus":"1"})):v.appendChild(I.create("br")),v}function L(){return tinymce.grep(G.getSelectedBlocks(),function(s){return/^(LI|DT|DD)$/.test(s.nodeName)})}function K(t,s,z){function y(A){tinymce.each(v,function(B){A.parentNode.insertBefore(B,s.parentNode)}),I.remove(A)}var x,w,v,u;for(v=I.select('span[data-mce-type="bookmark"]',t),z=z||M(s),x=I.createRng(),x.setStartAfter(s),x.setEndAfter(t),w=x.extractContents(),u=w.firstChild;u;u=u.firstChild){if("LI"==u.nodeName&&I.isEmpty(u)){I.remove(u);break}}I.isEmpty(w)||I.insertAfter(w,t),I.insertAfter(z,t),P(s.parentNode)&&y(s.parentNode),I.remove(s),P(t)&&I.remove(t)}function J(t){var s,u;if(s=t.nextSibling,s&&o(s)&&s.nodeName==t.nodeName&&E(t,s)){for(;u=s.firstChild;){t.appendChild(u)}I.remove(s)}if(s=t.previousSibling,s&&o(s)&&s.nodeName==t.nodeName&&E(t,s)){for(;u=s.firstChild;){t.insertBefore(u,t.firstChild)}I.remove(s)}}function H(s){tinymce.each(tinymce.grep(I.select("ol,ul",s)),function(u){var t,v=u.parentNode;"LI"==v.nodeName&&v.firstChild==u&&(t=v.previousSibling,t&&"LI"==t.nodeName&&(t.appendChild(u),P(v)&&I.remove(v))),o(v)&&(t=v.previousSibling,t&&"LI"==t.nodeName&&t.appendChild(u))})}function F(t){function s(x){P(x)&&I.remove(x)}var w,v=t.parentNode,u=v.parentNode;return k(v)?!0:"DD"==t.nodeName?(I.rename(t,"DT"),!0):n(t)&&m(t)?("LI"==u.nodeName?(I.insertAfter(t,u),s(u),I.remove(v)):o(u)?I.remove(v,!0):(u.insertBefore(M(t),v),I.remove(v)),!0):n(t)?("LI"==u.nodeName?(I.insertAfter(t,u),t.appendChild(v),s(u)):o(u)?u.insertBefore(t,v):(u.insertBefore(M(t),v),I.remove(t)),!0):m(t)?("LI"==u.nodeName?I.insertAfter(t,u):o(u)?I.insertAfter(t,v):(I.insertAfter(M(t),v),I.remove(t)),!0):("LI"==u.nodeName?(v=u,w=M(t,"LI")):w=o(u)?M(t,"LI"):M(t),K(v,t,w),H(v.parentNode),!0)}function i(t){function s(x,z){var y;if(o(x)){for(;y=t.lastChild.firstChild;){z.appendChild(y)}I.remove(x)}}var w,v,u;return"DT"==t.nodeName?(I.rename(t,"DD"),!0):(w=t.previousSibling,w&&o(w)?(w.appendChild(t),!0):w&&"LI"==w.nodeName&&o(w.lastChild)?(w.lastChild.appendChild(t),s(t.lastChild,w.lastChild),!0):(w=t.nextSibling,w&&o(w)?(w.insertBefore(t,w.firstChild),!0):(w=t.previousSibling,w&&"LI"==w.nodeName?(v=I.create(t.parentNode.nodeName),u=I.getStyle(t.parentNode,"listStyleType"),u&&I.setStyle(v,"listStyleType",u),w.appendChild(v),v.appendChild(t),s(t.lastChild,v),!0):!1)))}function g(){var s=L();if(s.length){for(var u=O(G.getRng(!0)),t=0;t<s.length&&(i(s[t])||0!==t);t++){}return N(u),r.nodeChanged(),!0}}function f(){var s=L();if(s.length){var x,w,v=O(G.getRng(!0)),u=r.getBody();for(x=s.length;x--;){for(var t=s[x].parentNode;t&&t!=u;){for(w=s.length;w--;){if(s[w]===t){s.splice(x,1);break}}t=t.parentNode}}for(x=0;x<s.length&&(F(s[x])||0!==x);x++){}return N(v),r.nodeChanged(),!0}}function e(s,x){function w(){function y(T){var S,U;for(S=u[T?"startContainer":"endContainer"],U=u[T?"startOffset":"endOffset"],1==S.nodeType&&(S=S.childNodes[Math.min(U,S.childNodes.length-1)]||S);S.parentNode!=D;){if(l(S)){return S}if(/^(TD|TH)$/.test(S.parentNode.nodeName)){return S}S=S.parentNode}return S}for(var R,Q=[],D=r.getBody(),C=y(!0),B=y(),A=[],z=C;z&&(A.push(z),z!=B);z=z.nextSibling){}return tinymce.each(A,function(T){if(l(T)){return Q.push(T),void (R=null)}if(I.isBlock(T)||p(T)){return p(T)&&I.remove(T),void (R=null)}var S=T.nextSibling;return tinymce.dom.BookmarkManager.isBookmarkNode(T)&&(l(S)||!S&&T.parentNode==D)?void (R=null):(R||(R=I.create("p"),T.parentNode.insertBefore(R,T),Q.push(R)),void R.appendChild(T))}),Q}var v,u=G.getRng(!0),t="LI";"false"!==I.getContentEditable(G.getNode())&&(s=s.toUpperCase(),"DL"==s&&(t="DT"),v=O(u),tinymce.each(w(),function(y){var B,A,z=function(D){var C=I.getStyle(D,"list-style-type"),Q=x?x["list-style-type"]:"";return Q=null===Q?"":Q,C===Q};A=y.previousSibling,A&&o(A)&&A.nodeName==s&&z(A)?(B=A,y=I.rename(y,t),A.appendChild(y)):(B=I.create(s),y.parentNode.insertBefore(B,y),B.appendChild(y),y=I.rename(y,t)),h(B,x),J(B)}),N(v))}function d(){var s=O(G.getRng(!0)),t=r.getBody();tinymce.each(L(),function(v){var u,w;if(!k(v.parentNode)){if(P(v)){return void F(v)}for(u=v;u&&u!=t;u=u.parentNode){o(u)&&(w=u)}K(w,v)}}),N(s)}function c(t,s){var v=I.getParent(G.getStart(),"OL,UL,DL");if(!k(v)){if(v){if(v.nodeName==t){d(t)}else{var u=O(G.getRng(!0));h(v,s),J(I.rename(v,t)),N(u)}}else{e(t,s)}}}function b(s){return function(){var t=I.getParent(r.selection.getStart(),"UL,OL,DL");return t&&t.nodeName==s}}function a(s){return p(s)?!(!I.isBlock(s.nextSibling)||p(s.previousSibling)):!1}var I=r.dom,G=r.selection,E=function(s,v){var u=r.dom.getStyle(s,"list-style-type",!0),t=r.dom.getStyle(v,"list-style-type",!0);return u===t},h=function(t,s){I.setStyle(t,"list-style-type",s?s["list-style-type"]:null)};j.backspaceDelete=function(x){function v(A,R){var Q,D,C=A.startContainer,B=A.startOffset;if(3==C.nodeType&&(R?B<C.data.length:B>0)){return C}for(Q=r.schema.getNonEmptyElements(),1==C.nodeType&&(C=tinymce.dom.RangeUtils.getNode(C,B)),D=new tinymce.dom.TreeWalker(C,r.getBody()),R&&a(C)&&D.next();C=D[R?"next":"prev2"]();){if("LI"==C.nodeName&&!C.hasChildNodes()){return C}if(Q[C.nodeName]){return C}if(3==C.nodeType&&C.data.length>0){return C}}}function u(A,Q){var D,C,B=A.parentNode;if(q(A)&&q(Q)){if(o(Q.lastChild)&&(C=Q.lastChild),B==Q.lastChild&&p(B.previousSibling)&&I.remove(B.previousSibling),D=Q.lastChild,D&&p(D)&&A.hasChildNodes()&&I.remove(D),P(Q,!0)&&I.$(Q).empty(),!P(A,!0)){for(;D=A.firstChild;){Q.appendChild(D)}}C&&Q.appendChild(C),I.remove(A),P(B)&&!k(B)&&I.remove(B)}}if(G.isCollapsed()){var t,s,z,y=I.getParent(G.getStart(),"LI");if(y){if(t=y.parentNode,k(t)&&I.isEmpty(t)){return !0}if(s=G.getRng(!0),z=I.getParent(v(s,x),"LI"),z&&z!=y){var w=O(s);return x?u(z,y):u(y,z),N(w),!0}if(!z&&!x&&d(t.nodeName)){return !0}}}},r.on("BeforeExecCommand",function(s){var u,t=s.command.toLowerCase();return"indent"==t?g()&&(u=!0):"outdent"==t&&f()&&(u=!0),u?(r.fire("ExecCommand",{command:s.command}),s.preventDefault(),!0):void 0}),r.addCommand("InsertUnorderedList",function(t,s){c("UL",s)}),r.addCommand("InsertOrderedList",function(t,s){c("OL",s)}),r.addCommand("InsertDefinitionList",function(t,s){c("DL",s)}),r.addQueryStateHandler("InsertUnorderedList",b("UL")),r.addQueryStateHandler("InsertOrderedList",b("OL")),r.addQueryStateHandler("InsertDefinitionList",b("DL")),r.on("keydown",function(s){9!=s.keyCode||tinymce.util.VK.metaKeyPressed(s)||r.dom.getParent(r.selection.getStart(),"LI,DT,DD")&&(s.preventDefault(),s.shiftKey?f():g())})}),r.addButton("indent",{icon:"indent",title:"Increase indent",cmd:"Indent",onPostRender:function(){var a=this;r.on("nodechange",function(){for(var t=r.selection.getSelectedBlocks(),s=!1,i=0,e=t.length;!s&&e>i;i++){var b=t[i].nodeName;s="LI"==b&&n(t[i])||"UL"==b||"OL"==b||"DD"==b}a.disabled(s)})}}),r.on("keydown",function(b){b.keyCode==tinymce.util.VK.BACKSPACE?j.backspaceDelete()&&b.preventDefault():b.keyCode==tinymce.util.VK.DELETE&&j.backspaceDelete(!0)&&b.preventDefault()})});