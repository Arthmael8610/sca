tinymce.PluginManager.add("media",function(F,E){function D(b){return b=b.toLowerCase(),-1!=b.indexOf(".mp3")?"audio/mpeg":-1!=b.indexOf(".wav")?"audio/wav":-1!=b.indexOf(".mp4")?"video/mp4":-1!=b.indexOf(".webm")?"video/webm":-1!=b.indexOf(".ogg")?"video/ogg":-1!=b.indexOf(".swf")?"application/x-shockwave-flash":""}function C(a){var f=F.settings.media_scripts;if(f){for(var e=0;e<f.length;e++){if(-1!==a.indexOf(f[e].filter)){return f[e]}}}}function B(){function f(e){var d,l,k,j;d=o.find("#width")[0],l=o.find("#height")[0],k=d.value(),j=l.value(),o.find("#constrain")[0].checked()&&n&&i&&k&&j&&(e.control==d?(j=Math.round(k/n*j),isNaN(j)||l.value(j)):(k=Math.round(j/i*k),isNaN(k)||d.value(k))),n=k,i=j}function p(){h=y(this.value()),this.parent().parent().fromJSON(h)}var o,n,i,h,g=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onchange:function(b){tinymce.each(b.meta,function(d,c){o.find("#"+c).value(d)})}}];F.settings.media_alt_source!==!1&&g.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"}),F.settings.media_poster!==!1&&g.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"}),F.settings.media_dimensions!==!1&&g.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:f,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:f,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),h=x(F.selection.getNode()),n=h.width,i=h.height;var a={id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:A(),multiline:!0,label:"Source"};a[q]=p,o=F.windowManager.open({title:"Insert/edit video",data:h,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){h=y(this.next().find("#embed").value()),this.fromJSON(h)},items:g},{title:"Embed",type:"container",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(z(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},a]}],onSubmit:function(){var j,m,l,k;for(j=F.dom.select("img[data-mce-object]"),F.insertContent(z(this.toJSON())),m=F.dom.select("img[data-mce-object]"),l=0;l<j.length;l++){for(k=m.length-1;k>=0;k--){j[l]==m[k]&&m.splice(k,1)}}F.selection.select(m[0]),F.nodeChanged()}})}function A(){var a=F.selection.getNode();return a.getAttribute("data-mce-object")?F.selection.getContent():void 0}function z(d){var c="";if(!d.source1&&(tinymce.extend(d,y(d.embed)),!d.source1)){return""}if(d.source2||(d.source2=""),d.poster||(d.poster=""),d.source1=F.convertURL(d.source1,"source"),d.source2=F.convertURL(d.source2,"source"),d.source1mime=D(d.source1),d.source2mime=D(d.source2),d.poster=F.convertURL(d.poster,"poster"),d.flashPlayerUrl=F.convertURL(E+"/moxieplayer.swf","movie"),tinymce.each(r,function(f){var e,h,g;if(e=f.regex.exec(d.source1)){for(g=f.url,h=0;e[h];h++){g=g.replace("$"+h,function(){return e[h]})}d.source1=g,d.type=f.type,d.allowFullscreen=f.allowFullscreen,d.width=d.width||f.w,d.height=d.height||f.h}}),d.embed){c=v(d.embed,d,!0)}else{var b=C(d.source1);if(b&&(d.type="script",d.width=b.width,d.height=b.height),d.width=d.width||300,d.height=d.height||150,tinymce.each(d,function(e,f){d[f]=F.dom.encode(e)}),"iframe"==d.type){var a=d.allowFullscreen?' allowFullscreen="1"':"";c+='<iframe src="'+d.source1+'" width="'+d.width+'" height="'+d.height+'"'+a+"></iframe>"}else{"application/x-shockwave-flash"==d.source1mime?(c+='<object data="'+d.source1+'" width="'+d.width+'" height="'+d.height+'" type="application/x-shockwave-flash">',d.poster&&(c+='<img src="'+d.poster+'" width="'+d.width+'" height="'+d.height+'" />'),c+="</object>"):-1!=d.source1mime.indexOf("audio")?F.settings.audio_template_callback?c=F.settings.audio_template_callback(d):c+='<audio controls="controls" src="'+d.source1+'">'+(d.source2?'\n<source src="'+d.source2+'"'+(d.source2mime?' type="'+d.source2mime+'"':"")+" />\n":"")+"</audio>":"script"==d.type?c+='<script src="'+d.source1+'"><\/script>':c=F.settings.video_template_callback?F.settings.video_template_callback(d):'<video width="'+d.width+'" height="'+d.height+'"'+(d.poster?' poster="'+d.poster+'"':"")+' controls="controls">\n<source src="'+d.source1+'"'+(d.source1mime?' type="'+d.source1mime+'"':"")+" />\n"+(d.source2?'<source src="'+d.source2+'"'+(d.source2mime?' type="'+d.source2mime+'"':"")+" />\n":"")+"</video>"}}return c}function y(d){var c={};return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(b,g){if(c.source1||"param"!=b||(c.source1=g.map.movie),"iframe"!=b&&"object"!=b&&"embed"!=b&&"video"!=b&&"audio"!=b||(c.type||(c.type=b),c=tinymce.extend(g.map,c)),"script"==b){var f=C(g.map.src);if(!f){return}c={type:"script",source1:g.map.src,width:f.width,height:f.height}}"source"==b&&(c.source1?c.source2||(c.source2=g.map.src):c.source1=g.map.src),"img"!=b||c.poster||(c.poster=g.map.src)}}).parse(d),c.source1=c.source1||c.src||c.data,c.source2=c.source2||"",c.poster=c.poster||"",c}function x(a){return a.getAttribute("data-mce-object")?y(F.serializer.serialize(a,{selection:!0})):{}}function w(a){if(F.settings.media_filter_html===!1){return a}var f,e=new tinymce.html.Writer;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!1,special:"script,noscript",comment:function(b){e.comment(b)},cdata:function(b){e.cdata(b)},text:function(d,c){e.text(d,c)},start:function(c,i,h){if(f=!0,"script"!=c&&"noscript"!=c){for(var d=0;d<i.length;d++){if(0===i[d].name.indexOf("on")){return}"style"==i[d].name&&(i[d].value=F.dom.serializeStyle(F.dom.parseStyle(i[d].value),c))}e.start(c,i,h),f=!1}},end:function(b){f||e.end(b)}},new tinymce.html.Schema({})).parse(a),e.getContent()}function v(i,h,n){function m(o,g){var I,H,G,p;for(I in g){if(G=""+g[I],o.map[I]){for(H=o.length;H--;){p=o[H],p.name==I&&(G?(o.map[I]=G,p.value=G):(delete o.map[I],o.splice(H,1)))}}else{G&&(o.push({name:I,value:G}),o.map[I]=G)}}}var l,k=new tinymce.html.Writer,j=0;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(b){k.comment(b)},cdata:function(b){k.cdata(b)},text:function(d,c){k.text(d,c)},start:function(b,d,c){switch(b){case"video":case"object":case"embed":case"img":case"iframe":m(d,{width:h.width,height:h.height})}if(n){switch(b){case"video":m(d,{poster:h.poster,src:""}),h.source2&&m(d,{src:""});break;case"iframe":m(d,{src:h.source1});break;case"source":if(j++,2>=j&&(m(d,{src:h["source"+j],type:h["source"+j+"mime"]}),!h["source"+j])){return}break;case"img":if(!h.poster){return}l=!0}}k.start(b,d,c)},end:function(b){if("video"==b&&n){for(var e=1;2>=e;e++){if(h["source"+e]){var d=[];d.map={},e>j&&(m(d,{src:h["source"+e],type:h["source"+e+"mime"]}),k.start("source",d,!0))}}}if(h.poster&&"object"==b&&n&&!l){var c=[];c.map={},m(c,{src:h.poster,width:h.width,height:h.height}),k.start("img",c,!0)}k.end(b)}},new tinymce.html.Schema({})).parse(i),k.getContent()}function u(a,n){var m,l,k,j,i;for(k=a.attributes,j=k.length;j--;){m=k[j].name,l=k[j].value,"width"!==m&&"height"!==m&&"style"!==m&&("data"!=m&&"src"!=m||(l=F.convertURL(l,m)),n.attr("data-mce-p-"+m,l))}i=a.firstChild&&a.firstChild.value,i&&(n.attr("data-mce-html",escape(i)),n.firstChild=null)}function t(e){var d,f=e.name;return d=new tinymce.html.Node("img",1),d.shortEnded=!0,u(e,d),d.attr({width:e.attr("width")||"300",height:e.attr("height")||("audio"==f?"30":"150"),style:e.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":f,"class":"mce-object mce-object-"+f}),d}function s(g){var f,j,i,h=g.name;return f=new tinymce.html.Node("span",1),f.attr({contentEditable:"false",style:g.attr("style"),"data-mce-object":h,"class":"mce-preview-object mce-object-"+h}),u(g,f),j=new tinymce.html.Node(h,1),j.attr({src:g.attr("src"),allowfullscreen:g.attr("allowfullscreen"),width:g.attr("width")||"300",height:g.attr("height")||("audio"==h?"30":"150"),frameborder:"0"}),i=new tinymce.html.Node("span",1),i.attr("class","mce-shim"),f.append(j),f.append(i),f}var r=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$2",allowFullscreen:!0},{regex:/youtube.com\/embed\/([a-z0-9\-_]+(?:\?.+)?)/i,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc",allowfullscreen:!0},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&amp;byline=0",allowfullscreen:!0},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"',allowFullscreen:!1},{regex:/dailymotion\.com\/video\/([^_]+)/,type:"iframe",w:480,h:270,url:"//www.dailymotion.com/embed/video/$1",allowFullscreen:!0}],q=tinymce.Env.ie&&tinymce.Env.ie<=8?"onChange":"onInput";F.on("ResolveName",function(d){var c;1==d.target.nodeType&&(c=d.target.getAttribute("data-mce-object"))&&(d.name=c)}),F.on("preInit",function(){var a=F.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(b){a[b]=new RegExp("</"+b+"[^>]*>","gi")});var d=F.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(b){d[b]={}}),F.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(h){for(var l,k,j,i=h.length;i--;){l=h[i],l.parent&&(l.parent.attr("data-mce-object")||("script"!=l.name||(j=C(l.attr("src"))))&&(j&&(j.width&&l.attr("width",j.width.toString()),j.height&&l.attr("height",j.height.toString())),k="iframe"==l.name&&F.settings.media_live_embeds!==!1&&tinymce.Env.ceFalse?s(l):t(l),l.replace(k)))}}),F.serializer.addAttributeFilter("data-mce-object",function(N,M){for(var L,K,J,I,H,G,p,o,n=N.length;n--;){if(L=N[n],L.parent){for(p=L.attr(M),K=new tinymce.html.Node(p,1),"audio"!=p&&"script"!=p&&(o=L.attr("class"),o&&-1!==o.indexOf("mce-preview-object")?K.attr({width:L.firstChild.attr("width"),height:L.firstChild.attr("height")}):K.attr({width:L.attr("width"),height:L.attr("height")})),K.attr({style:L.attr("style")}),I=L.attributes,J=I.length;J--;){var j=I[J].name;0===j.indexOf("data-mce-p-")&&K.attr(j.substr(11),I[J].value)}"script"==p&&K.attr("type","text/javascript"),H=L.attr("data-mce-html"),H&&(G=new tinymce.html.Node("#text",3),G.raw=!0,G.value=w(unescape(H)),K.append(G)),L.replace(K)}}})}),F.on("click keyup",function(){var a=F.selection.getNode();a&&F.dom.hasClass(a,"mce-preview-object")&&F.dom.getAttrib(a,"data-mce-selected")&&a.setAttribute("data-mce-selected","2")}),F.on("ObjectSelected",function(d){var c=d.target.getAttribute("data-mce-object");"audio"!=c&&"script"!=c||d.preventDefault()}),F.on("objectResized",function(e){var d,f=e.target;f.getAttribute("data-mce-object")&&(d=f.getAttribute("data-mce-html"),d&&(d=unescape(d),f.setAttribute("data-mce-html",escape(v(d,{width:e.width,height:e.height})))))}),F.addButton("media",{tooltip:"Insert/edit video",onclick:B,stateSelector:["img[data-mce-object]","span[data-mce-object]"]}),F.addMenuItem("media",{icon:"media",text:"Insert/edit video",onclick:B,context:"insert",prependToContext:!0}),F.on("setContent",function(){F.$("span.mce-preview-object").each(function(a,f){var e=F.$(f);0===e.find("span.mce-shim",f).length&&e.append('<span class="mce-shim"></span>')})}),F.addCommand("mceMedia",B),this.showDialog=B});