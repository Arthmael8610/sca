tinymce.PluginManager.add("layer",function(e){function f(g){do{if(g.className&&-1!=g.className.indexOf("mceItemLayer")){return g}}while(g=g.parentNode)}function a(g){var h=e.dom;tinymce.each(h.select("div,p",g),function(i){/^(absolute|relative|fixed)$/i.test(i.style.position)&&(i.hasVisual?h.addClass(i,"mceItemVisualAid"):h.removeClass(i,"mceItemVisualAid"),h.addClass(i,"mceItemLayer"))})}function b(j){var k,l,r=[],h=f(e.selection.getNode()),g=-1,i=-1;for(l=[],tinymce.walk(e.getBody(),function(m){1==m.nodeType&&/^(absolute|relative|static)$/i.test(m.style.position)&&l.push(m)},"childNodes"),k=0;k<l.length;k++){r[k]=l[k].style.zIndex?parseInt(l[k].style.zIndex,10):0,0>g&&l[k]==h&&(g=k)}if(0>j){for(k=0;k<r.length;k++){if(r[k]<r[g]){i=k;break}}i>-1?(l[g].style.zIndex=r[i],l[i].style.zIndex=r[g]):r[g]>0&&(l[g].style.zIndex=r[g]-1)}else{for(k=0;k<r.length;k++){if(r[k]>r[g]){i=k;break}}i>-1?(l[g].style.zIndex=r[i],l[i].style.zIndex=r[g]):l[g].style.zIndex=r[g]+1}e.execCommand("mceRepaint")}function c(){var g=e.dom,h=g.getPos(g.getParent(e.selection.getNode(),"*")),i=e.getBody();e.dom.add(i,"div",{style:{position:"absolute",left:h.x,top:h.y>20?h.y:20,width:100,height:100},"class":"mceItemVisualAid mceItemLayer"},e.selection.getContent()||e.getLang("layer.content")),tinymce.Env.ie&&g.setHTML(i,i.innerHTML)}function d(){var g=f(e.selection.getNode());g||(g=e.dom.getParent(e.selection.getNode(),"DIV,P,IMG")),g&&("absolute"==g.style.position.toLowerCase()?(e.dom.setStyles(g,{position:"",left:"",top:"",width:"",height:""}),e.dom.removeClass(g,"mceItemVisualAid"),e.dom.removeClass(g,"mceItemLayer")):(g.style.left||(g.style.left="20px"),g.style.top||(g.style.top="20px"),g.style.width||(g.style.width=g.width?g.width+"px":"100px"),g.style.height||(g.style.height=g.height?g.height+"px":"100px"),g.style.position="absolute",e.dom.setAttrib(g,"data-mce-style",""),e.addVisual(e.getBody())),e.execCommand("mceRepaint"),e.nodeChanged())}e.addCommand("mceInsertLayer",c),e.addCommand("mceMoveForward",function(){b(1)}),e.addCommand("mceMoveBackward",function(){b(-1)}),e.addCommand("mceMakeAbsolute",function(){d()}),e.addButton("moveforward",{title:"layer.forward_desc",cmd:"mceMoveForward"}),e.addButton("movebackward",{title:"layer.backward_desc",cmd:"mceMoveBackward"}),e.addButton("absolute",{title:"layer.absolute_desc",cmd:"mceMakeAbsolute"}),e.addButton("insertlayer",{title:"layer.insertlayer_desc",cmd:"mceInsertLayer"}),e.on("init",function(){tinymce.Env.ie&&e.getDoc().execCommand("2D-Position",!1,!0)}),e.on("mouseup",function(g){var h=f(g.target);h&&e.dom.setAttrib(h,"data-mce-style","")}),e.on("mousedown",function(j){var h,g=j.target,i=e.getDoc();tinymce.Env.gecko&&(f(g)?"on"!==i.designMode&&(i.designMode="on",g=i.body,h=g.parentNode,h.removeChild(g),h.appendChild(g)):"on"==i.designMode&&(i.designMode="off"))}),e.on("NodeChange",a)});