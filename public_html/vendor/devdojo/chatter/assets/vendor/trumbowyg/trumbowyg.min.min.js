jQuery.trumbowyg={langs:{en:{viewHTML:"View HTML",undo:"Undo",redo:"Redo",formatting:"Formatting",p:"Paragraph",blockquote:"Quote",code:"Code",header:"Header",bold:"Bold",italic:"Italic",strikethrough:"Stroke",underline:"Underline",strong:"Strong",em:"Emphasis",del:"Deleted",superscript:"Superscript",subscript:"Subscript",unorderedList:"Unordered list",orderedList:"Ordered list",insertImage:"Insert Image",link:"Link",createLink:"Insert link",unlink:"Remove link",justifyLeft:"Align Left",justifyCenter:"Align Center",justifyRight:"Align Right",justifyFull:"Align Justify",horizontalRule:"Insert horizontal rule",removeformat:"Remove format",fullscreen:"Fullscreen",close:"Close",submit:"Confirm",reset:"Cancel",required:"Required",description:"Description",title:"Title",text:"Text",target:"Target"}},plugins:{},svgPath:null,hideButtonTexts:null},function(d,c,g,b){b.fn.trumbowyg=function(k,h){var l="trumbowyg";if(k===Object(k)||!k){return this.each(function(){b(this).data(l)||b(this).data(l,new f(this,k))})}if(1===this.length){try{var j=b(this).data(l);switch(k){case"execCmd":return j.execCmd(h.cmd,h.param,h.forceCss);case"openModal":return j.openModal(h.title,h.content);case"closeModal":return j.closeModal();case"openModalInsert":return j.openModalInsert(h.title,h.fields,h.callback);case"saveRange":return j.saveRange();case"getRange":return j.range;case"getRangeText":return j.getRangeText();case"restoreRange":return j.restoreRange();case"enable":return j.toggleDisable(!1);case"disable":return j.toggleDisable(!0);case"destroy":return j.destroy();case"empty":return j.empty();case"html":return j.html(h)}}catch(a){}}return !1};var f=function(h,a){var k=this,w="trumbowyg-icons";k.doc=h.ownerDocument||g,k.$ta=b(h),k.$c=b(h),a=a||{},null!=a.lang||null!=b.trumbowyg.langs[a.lang]?k.lang=b.extend(!0,{},b.trumbowyg.langs.en,b.trumbowyg.langs[a.lang]):k.lang=b.trumbowyg.langs.en,k.hideButtonTexts=null!=b.trumbowyg.hideButtonTexts?b.trumbowyg.hideButtonTexts:a.hideButtonTexts;var j=null!=b.trumbowyg.svgPath?b.trumbowyg.svgPath:a.svgPath;if(k.hasSvg=j!==!1,k.svgPath=k.doc.querySelector("base")?c.location.href.split("#")[0]:"",0===b("#"+w,k.doc).length&&j!==!1){if(null==j){try{throw new Error}catch(q){var t=q.stack.split("\n");for(var v in t){if(t[v].match(/http[s]?:\/\//)){j=t[Number(v)].match(/((http[s]?:\/\/.+\/)([^\/]+\.js))(\?.*)?:/)[1].split("/"),j.pop(),j=j.join("/")+"/ui/icons.svg";break}}}}var m=k.doc.createElement("div");m.id=w,k.doc.body.insertBefore(m,k.doc.body.childNodes[0]),b.ajax({async:!0,type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",dataType:"xml",url:j,data:null,beforeSend:null,complete:null,success:function(i){m.innerHTML=(new XMLSerializer).serializeToString(i.documentElement)}})}var n=k.lang.header,e=function(){return(c.chrome||c.Intl&&Intl.v8BreakIterator)&&"CSS" in c};k.btnsDef={viewHTML:{fn:"toggle"},undo:{isSupported:e,key:"Z"},redo:{isSupported:e,key:"Y"},p:{fn:"formatBlock"},blockquote:{fn:"formatBlock"},h1:{fn:"formatBlock",title:n+" 1"},h2:{fn:"formatBlock",title:n+" 2"},h3:{fn:"formatBlock",title:n+" 3"},h4:{fn:"formatBlock",title:n+" 4"},subscript:{tag:"sub"},superscript:{tag:"sup"},bold:{key:"B",tag:"b"},italic:{key:"I",tag:"i"},underline:{tag:"u"},strikethrough:{tag:"strike"},strong:{fn:"bold",key:"B"},em:{fn:"italic",key:"I"},del:{fn:"strikethrough"},createLink:{key:"K",tag:"a"},unlink:{},insertImage:{},justifyLeft:{tag:"left",forceCss:!0},justifyCenter:{tag:"center",forceCss:!0},justifyRight:{tag:"right",forceCss:!0},justifyFull:{tag:"justify",forceCss:!0},unorderedList:{fn:"insertUnorderedList",tag:"ul"},orderedList:{fn:"insertOrderedList",tag:"ol"},horizontalRule:{fn:"insertHorizontalRule"},removeformat:{},fullscreen:{"class":"trumbowyg-not-disable"},close:{fn:"destroy","class":"trumbowyg-not-disable"},formatting:{dropdown:["p","blockquote","h1","h2","h3","h4"],ico:"p"},link:{dropdown:["createLink","unlink"]}},k.o=b.extend(!0,{},{lang:"en",fixedBtnPane:!1,fixedFullWidth:!1,autogrow:!1,prefix:"trumbowyg-",semantic:!0,resetCss:!1,removeformatPasted:!1,tagsToRemove:[],btnsGrps:{design:["bold","italic","underline","strikethrough"],semantic:["strong","em","del"],justify:["justifyLeft","justifyCenter","justifyRight","justifyFull"],lists:["unorderedList","orderedList"]},btns:[["viewHTML"],["undo","redo"],["formatting"],"btnGrp-semantic",["superscript","subscript"],["link"],["insertImage"],"btnGrp-justify","btnGrp-lists",["horizontalRule"],["removeformat"],["fullscreen"]],btnsDef:{},inlineElementsSelector:"a,abbr,acronym,b,caption,cite,code,col,dfn,dir,dt,dd,em,font,hr,i,kbd,li,q,span,strikeout,strong,sub,sup,u",pasteHandlers:[],imgDblClickHandler:function(){var l=b(this),i=l.attr("src"),o="(Base64)";return 0===i.indexOf("data:image")&&(i=o),k.openModalInsert(k.lang.insertImage,{url:{label:"URL",value:i,required:!0},alt:{label:k.lang.description,value:l.attr("alt")}},function(p){return p.src!==o&&l.attr({src:p.src}),l.attr({alt:p.alt}),!0}),!1},plugins:{}},a),k.disabled=k.o.disabled||"TEXTAREA"===h.nodeName&&h.disabled,a.btns?k.o.btns=a.btns:k.o.semantic||(k.o.btns[4]="btnGrp-design"),b.each(k.o.btnsDef,function(l,i){k.addBtnDef(l,i)}),k.eventNamespace="trumbowyg-event",k.keys=[],k.tagToButton={},k.tagHandlers=[],k.pasteHandlers=[].concat(k.o.pasteHandlers),k.isIE=-1!==d.userAgent.indexOf("MSIE")||-1!==d.appVersion.indexOf("Trident/"),k.init()};f.prototype={init:function(){var h=this;h.height=h.$ta.height(),h.initPlugins();try{h.doc.execCommand("enableObjectResizing",!1,!1),h.doc.execCommand("defaultParagraphSeparator",!1,"p")}catch(a){}h.buildEditor(),h.buildBtnPane(),h.fixedBtnPaneEvents(),h.buildOverlay(),setTimeout(function(){h.disabled&&h.toggleDisable(!0),h.$c.trigger("tbwinit")})},addBtnDef:function(h,a){this.btnsDef[h]=a},buildEditor:function(){var m=this,q=m.o.prefix,p="";m.$box=b("<div/>",{"class":q+"box "+q+"editor-visible "+q+m.o.lang+" trumbowyg"}),m.isTextarea=m.$ta.is("textarea"),m.isTextarea?(p=m.$ta.val(),m.$ed=b("<div/>"),m.$box.insertAfter(m.$ta).append(m.$ed,m.$ta)):(m.$ed=m.$ta,p=m.$ed.html(),m.$ta=b("<textarea/>",{name:m.$ta.attr("id"),height:m.height}).val(p),m.$box.insertAfter(m.$ed).append(m.$ta,m.$ed),m.syncCode()),m.$ta.addClass(q+"textarea").attr("tabindex",-1),m.$ed.addClass(q+"editor").attr({contenteditable:!0,dir:m.lang._dir||"ltr"}).html(p),m.o.tabindex&&m.$ed.attr("tabindex",m.o.tabindex),m.$c.is("[placeholder]")&&m.$ed.attr("placeholder",m.$c.attr("placeholder")),m.o.resetCss&&m.$ed.addClass(q+"reset-css"),m.o.autogrow||m.$ta.add(m.$ed).css({height:m.height}),m.semanticCode();var k,h=!1,j=!1,a=m.isIE?"keyup":"input";m.$ed.on("dblclick","img",m.o.imgDblClickHandler).on("keydown",function(i){if(i.ctrlKey){h=!0;var l=m.keys[String.fromCharCode(i.which).toUpperCase()];try{return m.execCmd(l.fn,l.param),!1}catch(e){}}}).on("compositionstart compositionupdate",function(){j=!0}).on(a+" compositionend",function(e){if("compositionend"===e.type){j=!1}else{if(j){return}}var i=e.which;i>=37&&40>=i||(!e.ctrlKey||89!==i&&90!==i?h||17===i?"undefined"==typeof e.which&&m.semanticCode(!1,!1,!0):(m.semanticCode(!1,13===i),m.$c.trigger("tbwchange")):m.$c.trigger("tbwchange"),setTimeout(function(){h=!1},200))}).on("mouseup keydown keyup",function(){clearTimeout(k),k=setTimeout(function(){m.updateButtonPaneStatus()},50)}).on("focus blur",function(e){m.$c.trigger("tbw"+e.type),"blur"===e.type&&b("."+q+"active-button",m.$btnPane).removeClass(q+"active-button "+q+"active")}).on("cut",function(){setTimeout(function(){m.semanticCode(!1,!0),m.$c.trigger("tbwchange")},0)}).on("paste",function(t){if(m.o.removeformatPasted){t.preventDefault();try{var s=c.clipboardData.getData("Text");try{m.doc.selection.createRange().pasteHTML(s)}catch(l){m.doc.getSelection().getRangeAt(0).insertNode(m.doc.createTextNode(s))}}catch(e){m.execCmd("insertText",(t.originalEvent||t).clipboardData.getData("text/plain"))}}b.each(m.pasteHandlers,function(n,i){i(t)}),setTimeout(function(){m.semanticCode(!1,!0),m.$c.trigger("tbwpaste",t)},0)}),m.$ta.on("keyup paste",function(){m.$c.trigger("tbwchange")}),m.$box.on("keydown",function(e){return 27===e.which&&1===b("."+q+"modal-box",m.$box).length?(m.closeModal(),!1):void 0})},buildBtnPane:function(){var h=this,a=h.o.prefix,i=h.$btnPane=b("<div/>",{"class":a+"button-pane"});b.each(h.o.btns,function(n,m){try{var j=m.split("btnGrp-");null!=j[1]&&(m=h.o.btnsGrps[j[1]])}catch(k){}b.isArray(m)||(m=[m]);var e=b("<div/>",{"class":a+"button-group "+(m.indexOf("fullscreen")>=0?a+"right":"")});b.each(m,function(p,r){try{var l;h.isSupportedBtn(r)&&(l=h.buildBtn(r)),e.append(l)}catch(q){}}),i.append(e)}),h.$box.prepend(i)},buildBtn:function(p){var v=this,j=v.o.prefix,h=v.btnsDef[p],a=h.dropdown,m=null!=h.hasIcon?h.hasIcon:!0,w=v.lang[p]||p,k=b("<button/>",{type:"button","class":j+p+"-button "+(h["class"]||"")+(m?"":" "+j+"textual-button"),html:v.hasSvg&&m?'<svg><use xlink:href="'+v.svgPath+"#"+j+(h.ico||p).replace(/([A-Z]+)/g,"-$1").toLowerCase()+'"/></svg>':v.hideButtonTexts?"":h.text||h.title||v.lang[p]||p,title:(h.title||h.text||w)+(h.key?" (Ctrl + "+h.key+")":""),tabindex:-1,mousedown:function(){return(!a||b("."+p+"-"+j+"dropdown",v.$box).is(":hidden"))&&b("body",v.doc).trigger("mousedown"),!v.$btnPane.hasClass(j+"disable")||b(this).hasClass(j+"active")||b(this).hasClass(j+"not-disable")?(v.execCmd((a?"dropdown":!1)||h.fn||p,h.param||p,h.forceCss||!1),!1):!1}});if(a){k.addClass(j+"open-dropdown");var q=j+"dropdown",u=b("<div/>",{"class":q+"-"+p+" "+q+" "+j+"fixed-top","data-dropdown":p});b.each(a,function(i,l){v.btnsDef[l]&&v.isSupportedBtn(l)&&u.append(v.buildSubBtn(l))}),v.$box.append(u.hide())}else{h.key&&(v.keys[h.key]={fn:h.fn||p,param:h.param||p})}return a||(v.tagToButton[(h.tag||p).toLowerCase()]=p),k},buildSubBtn:function(i){var a=this,k=a.o.prefix,j=a.btnsDef[i],h=null!=j.hasIcon?j.hasIcon:!0;return j.key&&(a.keys[j.key]={fn:j.fn||i,param:j.param||i}),a.tagToButton[(j.tag||i).toLowerCase()]=i,b("<button/>",{type:"button","class":k+i+"-dropdown-button"+(j.ico?" "+k+j.ico+"-button":""),html:a.hasSvg&&h?'<svg><use xlink:href="'+a.svgPath+"#"+k+(j.ico||i).replace(/([A-Z]+)/g,"-$1").toLowerCase()+'"/></svg>'+(j.text||j.title||a.lang[i]||i):j.text||j.title||a.lang[i]||i,title:j.key?" (Ctrl + "+j.key+")":null,style:j.style||null,mousedown:function(){return b("body",a.doc).trigger("mousedown"),a.execCmd(j.fn||i,j.param||i,j.forceCss||!1),!1}})},isSupportedBtn:function(h){try{return this.btnsDef[h].isSupported()}catch(a){}return !0},buildOverlay:function(){var a=this;return a.$overlay=b("<div/>",{"class":a.o.prefix+"overlay"}).css({top:a.$btnPane.outerHeight(),height:a.$ed.outerHeight()+1+"px"}).appendTo(a.$box),a.$overlay},showOverlay:function(){var a=this;b(c).trigger("scroll"),a.$overlay.fadeIn(200),a.$box.addClass(a.o.prefix+"box-blur")},hideOverlay:function(){var a=this;a.$overlay.fadeOut(50),a.$box.removeClass(a.o.prefix+"box-blur")},fixedBtnPaneEvents:function(){var a=this,i=a.o.fixedFullWidth,h=a.$box;a.o.fixedBtnPane&&(a.isFixed=!1,b(c).on("scroll."+a.eventNamespace+" resize."+a.eventNamespace,function(){if(h){a.syncCode();var m=b(c).scrollTop(),j=h.offset().top+1,k=a.$btnPane,e=k.outerHeight()-2;m-j>0&&m-j-a.height<0?(a.isFixed||(a.isFixed=!0,k.css({position:"fixed",top:0,left:i?"0":"auto",zIndex:7}),b([a.$ta,a.$ed]).css({marginTop:k.height()})),k.css({width:i?"100%":h.width()-1+"px"}),b("."+a.o.prefix+"fixed-top",h).css({position:i?"fixed":"absolute",top:i?e:e+(m-j)+"px",zIndex:15})):a.isFixed&&(a.isFixed=!1,k.removeAttr("style"),b([a.$ta,a.$ed]).css({marginTop:0}),b("."+a.o.prefix+"fixed-top",h).css({position:"absolute",top:e}))}}))},toggleDisable:function(h){var a=this,i=a.o.prefix;a.disabled=h,h?a.$ta.attr("disabled",!0):a.$ta.removeAttr("disabled"),a.$box.toggleClass(i+"disabled",h),a.$ed.attr("contenteditable",!h)},destroy:function(){var a=this,i=a.o.prefix,h=a.height;a.isTextarea?a.$box.after(a.$ta.css({height:h}).val(a.html()).removeClass(i+"textarea").show()):a.$box.after(a.$ed.css({height:h}).removeClass(i+"editor").removeAttr("contenteditable").html(a.html()).show()),a.$ed.off("dblclick","img"),a.destroyPlugins(),a.$box.remove(),a.$c.removeData("trumbowyg"),b("body").removeClass(i+"body-fullscreen"),a.$c.trigger("tbwclose"),b(c).off("scroll."+a.eventNamespace+" resize."+a.eventNamespace)},empty:function(){this.$ta.val(""),this.syncCode(!0)},toggle:function(){var h=this,a=h.o.prefix;h.semanticCode(!1,!0),setTimeout(function(){h.doc.activeElement.blur(),h.$box.toggleClass(a+"editor-hidden "+a+"editor-visible"),h.$btnPane.toggleClass(a+"disable"),b("."+a+"viewHTML-button",h.$btnPane).toggleClass(a+"active"),h.$box.hasClass(a+"editor-visible")?h.$ta.attr("tabindex",-1):h.$ta.removeAttr("tabindex")},0)},dropdown:function(m){var t=this,q=t.doc,k=t.o.prefix,h=b("[data-dropdown="+m+"]",t.$box),j=b("."+k+m+"-button",t.$btnPane),a=h.is(":hidden");if(b("body",q).trigger("mousedown"),a){var p=j.offset().left;j.addClass(k+"active"),h.css({position:"absolute",top:j.offset().top-t.$btnPane.offset().top+j.outerHeight(),left:t.o.fixedFullWidth&&t.isFixed?p+"px":p-t.$btnPane.offset().left+"px"}).show(),b(c).trigger("scroll"),b("body",q).on("mousedown."+t.eventNamespace,function(i){h.is(i.target)||(b("."+k+"dropdown",q).hide(),b("."+k+"active",q).removeClass(k+"active"),b("body",q).off("mousedown."+t.eventNamespace))})}},html:function(h){var a=this;return null!=h?(a.$ta.val(h),a.syncCode(!0),a):a.$ta.val()},syncTextarea:function(){var a=this;a.$ta.val(a.$ed.text().trim().length>0||a.$ed.find("hr,img,embed,iframe,input").length>0?a.$ed.html():"")},syncCode:function(h){var a=this;!h&&a.$ed.is(":visible")?a.syncTextarea():a.$ed.html(a.$ta.val()),a.o.autogrow&&(a.height=a.$ed.height(),a.height!==a.$ta.css("height")&&(a.$ta.css({height:a.height}),a.$c.trigger("tbwresize")))},semanticCode:function(l,h,p){var m=this;if(m.saveRange(),m.syncCode(l),b(m.o.tagsToRemove.join(","),m.$ed).remove(),m.o.semantic){if(m.semanticTag("b","strong"),m.semanticTag("i","em"),h){var k=m.o.inlineElementsSelector,a=":not("+k+")";m.$ed.contents().filter(function(){return 3===this.nodeType&&this.nodeValue.trim().length>0}).wrap("<span data-tbw/>");var j=function(o){if(0!==o.length){var i=o.nextUntil(a).addBack().wrapAll("<p/>").parent(),q=i.nextAll(k).first();i.next("br").remove(),j(q)}};j(m.$ed.children(k).first()),m.semanticTag("div","p",!0),m.$ed.find("p").filter(function(){return m.range&&this===m.range.startContainer?!1:0===b(this).text().trim().length&&0===b(this).children().not("br,span").length}).contents().unwrap(),b("[data-tbw]",m.$ed).contents().unwrap(),m.$ed.find("p:empty").remove()}p||m.restoreRange(),m.syncTextarea()}},semanticTag:function(h,a,i){b(h,this.$ed).each(function(){var j=b(this);j.wrap("<"+a+"/>"),i&&b.each(j.prop("attributes"),function(){j.parent().attr(this.name,this.value)}),j.contents().unwrap()})},createLink:function(){for(var p,j,u,q=this,m=q.doc.getSelection(),h=m.focusNode;["A","DIV"].indexOf(h.nodeName)<0;){h=h.parentNode}if(h&&"A"===h.nodeName){var k=b(h);p=k.attr("href"),j=k.attr("title"),u=k.attr("target");var a=q.doc.createRange();a.selectNode(h),m.addRange(a)}q.saveRange(),q.openModalInsert(q.lang.createLink,{url:{label:"URL",required:!0,value:p},title:{label:q.lang.title,value:j},text:{label:q.lang.text,value:q.getRangeText()},target:{label:q.lang.target,value:u}},function(l){var i=b(['<a href="',l.url,'">',l.text,"</a>"].join(""));return l.title.length>0&&i.attr("title",l.title),l.target.length>0&&i.attr("target",l.target),q.range.deleteContents(),q.range.insertNode(i[0]),!0})},unlink:function(){var j=this,i=j.doc.getSelection(),k=i.focusNode;if(i.isCollapsed){for(;["A","DIV"].indexOf(k.nodeName)<0;){k=k.parentNode}if(k&&"A"===k.nodeName){var h=j.doc.createRange();h.selectNode(k),i.addRange(h)}}j.execCmd("unlink",void 0,void 0,!0)},insertImage:function(){var a=this;a.saveRange(),a.openModalInsert(a.lang.insertImage,{url:{label:"URL",required:!0},alt:{label:a.lang.description,value:a.getRangeText()}},function(e){return a.execCmd("insertImage",e.url),b('img[src="'+e.url+'"]:not([alt])',a.$box).attr("alt",e.alt),!0})},fullscreen:function(){var h,j=this,i=j.o.prefix,a=i+"fullscreen";j.$box.toggleClass(a),h=j.$box.hasClass(a),b("body").toggleClass(i+"body-fullscreen",h),b(c).trigger("scroll"),j.$c.trigger("tbw"+(h?"open":"close")+"fullscreen")},execCmd:function(m,k,q,h){var p=this;h=!!h||"","dropdown"!==m&&p.$ed.focus();try{p.doc.execCommand("styleWithCSS",!1,q||!1)}catch(l){}try{p[m+h](k)}catch(l){try{m(k)}catch(j){"insertHorizontalRule"===m?k=void 0:"formatBlock"===m&&p.isIE&&(k="<"+k+">"),p.doc.execCommand(m,!1,k),p.syncCode(),p.semanticCode(!1,!0)}"dropdown"!==m&&(p.updateButtonPaneStatus(),p.$c.trigger("tbwchange"))}},openModal:function(m,q){var p=this,k=p.o.prefix;if(b("."+k+"modal-box",p.$box).length>0){return !1}p.saveRange(),p.showOverlay(),p.$btnPane.addClass(k+"disable");var h=b("<div/>",{"class":k+"modal "+k+"fixed-top"}).css({top:p.$btnPane.height()}).appendTo(p.$box);p.$overlay.one("click",function(){return h.trigger("tbwcancel"),!1});var j=b("<form/>",{action:"",html:q}).on("submit",function(){return h.trigger("tbwconfirm"),!1}).on("reset",function(){return h.trigger("tbwcancel"),!1}),a=b("<div/>",{"class":k+"modal-box",html:j}).css({top:"-"+p.$btnPane.outerHeight()+"px",opacity:0}).appendTo(h).animate({top:0,opacity:1},100);return b("<span/>",{text:m,"class":k+"modal-title"}).prependTo(a),h.height(a.outerHeight()+10),b("input:first",a).focus(),p.buildModalBtn("submit",a),p.buildModalBtn("reset",a),b(c).trigger("scroll"),h},buildModalBtn:function(h,a){var j=this,i=j.o.prefix;return b("<button/>",{"class":i+"modal-button "+i+"modal-"+h,type:h,text:j.lang[h]||h}).appendTo(b("form",a))},closeModal:function(){var h=this,a=h.o.prefix;h.$btnPane.removeClass(a+"disable"),h.$overlay.off();var i=b("."+a+"modal-box",h.$box);i.animate({top:"-"+i.height()},100,function(){i.parent().remove(),h.hideOverlay()}),h.restoreRange()},openModalInsert:function(p,j,u){var q=this,m=q.o.prefix,h=q.lang,k="",a="tbwconfirm";return b.each(j,function(v,s){var x=s.label,r=s.name||v,w=s.attributes||{},i=Object.keys(w).map(function(l){return l+'="'+w[l]+'"'}).join(" ");k+='<label><input type="'+(s.type||"text")+'" name="'+r+'" value="'+(s.value||"").replace(/"/g,"&quot;")+'"'+i+'><span class="'+m+'input-infos"><span>'+(x?h[x]?h[x]:x:h[v]?h[v]:v)+"</span></span></label>"}),q.openModal(p,k).on(a,function(){var o=b("form",b(this)),n=!0,l={};b.each(j,function(i,v){var r=b('input[name="'+i+'"]',o),e=r.attr("type");"checkbox"===e.toLowerCase()?l[i]=r.is(":checked"):l[i]=b.trim(r.val()),v.required&&""===l[i]?(n=!1,q.addErrorOnModalField(r,q.lang.required)):v.pattern&&!v.pattern.test(l[i])&&(n=!1,q.addErrorOnModalField(r,v.patternError))}),n&&(q.restoreRange(),u(l,j)&&(q.syncCode(),q.$c.trigger("tbwchange"),q.closeModal(),b(this).off(a)))}).one("tbwcancel",function(){b(this).off(a),q.closeModal()})},addErrorOnModalField:function(h,a){var j=this.o.prefix,i=h.parent();h.on("change keyup",function(){i.removeClass(j+"input-error")}),i.addClass(j+"input-error").find("input+span").append(b("<span/>",{"class":j+"msg-error",text:a}))},saveRange:function(){var j=this,i=j.doc.getSelection();if(j.range=null,i.rangeCount){var l,h=j.range=i.getRangeAt(0),k=j.doc.createRange();k.selectNodeContents(j.$ed[0]),k.setEnd(h.startContainer,h.startOffset),l=(k+"").length,j.metaRange={start:l,end:l+(h+"").length}}},restoreRange:function(){var v,A=this,k=A.metaRange,y=A.range,j=A.doc.getSelection();if(y){if(k&&k.start!==k.end){var h,p=0,B=[A.$ed[0]],m=!1,w=!1;for(v=A.doc.createRange();!w&&(h=B.pop());){if(3===h.nodeType){var x=p+h.length;!m&&k.start>=p&&k.start<=x&&(v.setStart(h,k.start-p),m=!0),m&&k.end>=p&&k.end<=x&&(v.setEnd(h,k.end-p),w=!0),p=x}else{for(var z=h.childNodes,q=z.length;q>0;){q-=1,B.push(z[q])}}}}j.removeAllRanges(),j.addRange(v||y)}},getRangeText:function(){return this.range+""},updateButtonPaneStatus:function(){var h=this,a=h.o.prefix,j=h.getTagsRecursive(h.doc.getSelection().focusNode),i=a+"active-button "+a+"active";b("."+a+"active-button",h.$btnPane).removeClass(i),b.each(j,function(q,o){var k=h.tagToButton[o.toLowerCase()],m=b("."+a+k+"-button",h.$btnPane);if(m.length>0){m.addClass(i)}else{try{m=b("."+a+"dropdown ."+a+k+"-dropdown-button",h.$box);var e=m.parent().data("dropdown");b("."+a+e+"-button",h.$box).addClass(i)}catch(p){}}})},getTagsRecursive:function(h,a){var j=this;if(a=a||(h&&h.tagName?[h.tagName]:[]),!h||!h.parentNode){return a}h=h.parentNode;var i=h.tagName;return"DIV"===i?a:("P"===i&&""!==h.style.textAlign&&a.push(h.style.textAlign),b.each(j.tagHandlers,function(e,k){a=a.concat(k(h,j))}),a.push(i),j.getTagsRecursive(h,a))},initPlugins:function(){var a=this;a.loadedPlugins=[],b.each(b.trumbowyg.plugins,function(e,h){(!h.shouldInit||h.shouldInit(a))&&(h.init(a),h.tagHandler&&a.tagHandlers.push(h.tagHandler),a.loadedPlugins.push(h))})},destroyPlugins:function(){b.each(this.loadedPlugins,function(h,a){a.destroy&&a.destroy()})}}}(navigator,window,document,jQuery);